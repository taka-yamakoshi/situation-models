---
title: "R Notebook"
output: html_notebook
---

# Import dependencies

```{r}
library(tidyverse)
library(here)
library(ggthemes)
library(tidyboot)
library(ggh4x)
library(ggridges)
```


```{r}
colorblind_pal()(8)
```
"#E69F00","#D55E00","#56B4E9","#009E73","#000000"

# fine-grained analyses

```{r,message=FALSE}
#model_name <- 'albert-xxlarge-v2'
model_name <- 'roberta-large'
d.zindiv.raw <- read_csv(here(str_glue('results/combined_effect_ave_z_rep_{model_name}.csv')))
d.qry.raw <- read_csv(here(str_glue('results/combined_effect_ave_query_{model_name}.csv')))
d.key.raw <- read_csv(here(str_glue('results/combined_effect_ave_key_{model_name}.csv')))
d.val.raw <- read_csv(here(str_glue('results/combined_effect_ave_value_{model_name}.csv')))
```

```{r}
d.zindiv.raw %>% 
  filter(head_id==0, layer_id==0, pos_type=='context', interv_type=='original') %>%
  mutate(acc = original_1>original_2) %>%
  #mutate(acc = original_1> 0 & original_2<0) %>%
  group_by(cue_type) %>%
  summarize(perf = mean(acc), num = sum(acc), total = sum(acc>-1))
```

```{r}
sent_list <- d.zindiv.raw %>%
  filter((layer_id==0)&(head_id==0)&(pos_type=='context')&(interv_type=='original')) %>%
  separate(pair_id, into = c('prefix', 'pair_id')) %>%
  mutate(original_score_weak = original_1 > original_2) %>%
  select(c("pair_id","original_score","original_score_weak","cue_type")) %>%
  #pivot_wider(names_from="cue_type",values_from="original_score") %>%
  pivot_wider(names_from="cue_type",values_from="original_score_weak") %>%
  mutate(group_score=str_c(context,verb,sep="-")) %>%
  filter(group_score=="TRUE-TRUE") %>%
  pull("pair_id")
```

```{r}
preprocess <- function(d) {
  d %>%
    separate(pair_id, into = c('prefix', 'pair_id')) %>%
    filter(pair_id %in% sent_list) %>%
    mutate(layer_id=layer_id+1) %>%
    mutate(head_id=head_id+1) %>%
    return()
}

calc_effect <- function(data) {
  new_data <- data %>%
  mutate(prob_1_1=exp(logprob_ave_option_1_sent_1),
         prob_2_1=exp(logprob_ave_option_2_sent_1),
         prob_1_2=exp(logprob_ave_option_1_sent_2),
         prob_2_2=exp(logprob_ave_option_2_sent_2)) %>%
  select(-c('original_1','original_2','interv_1','interv_2','effect_1','effect_2','effect_ave')) %>%
  select(-c('logprob_ave_option_1_sent_1','logprob_ave_option_2_sent_1',
            'logprob_ave_option_1_sent_2','logprob_ave_option_2_sent_2')) %>%
  select(-c('logprob_sum_option_1_sent_1','logprob_sum_option_2_sent_1',
            'logprob_sum_option_1_sent_2','logprob_sum_option_2_sent_2')) %>%
  pivot_wider(names_from='interv_type',values_from=c('prob_1_1','prob_2_1','prob_1_2','prob_2_2')) %>%
  mutate(effect_1_1=(prob_1_1_original-prob_1_1_interv), #/prob_1_1_original,
         effect_2_1=(prob_2_1_interv-prob_2_1_original), #/prob_2_1_interv,
         effect_1_2=(prob_1_2_interv-prob_1_2_original), #/prob_1_2_interv,
         effect_2_2=(prob_2_2_original-prob_2_2_interv)) %>% #/prob_2_2_original) %>%
  mutate(effect_ave = (effect_1_1+effect_2_1+effect_1_2+effect_2_2)/4)
  #mutate(effect_ave = (effect_1_1+effect_2_2)/2)
  return(new_data)
}
```
```{r}
d.zindiv <- preprocess(d.zindiv.raw) %>% filter(interv_type=='interv') # %>% calc_effect()
d.qry <- preprocess(d.qry.raw) %>% filter(interv_type=='interv') # %>% calc_effect()
d.key <- preprocess(d.key.raw) %>% filter(interv_type=='interv') # %>% calc_effect()
d.val <- preprocess(d.val.raw) %>% filter(interv_type=='interv') # %>% calc_effect()
```

# Count how many heads are involved in this circuit

```{r}
p_threshold <- 0.05
head_list <- d.zindiv %>%
  filter(cue_type=="context") %>%
  group_by(layer_id, head_id, pos_type) %>%
  summarize(p.val = t.test(effect_ave)$p.value,
            t.val = t.test(effect_ave)$statistic) %>%
  filter(p.val < p_threshold/12/64/7/2) %>%
  pull(head_id) %>% unique()
length(head_list)
```



```{r}
pos_type_list <- c('context','verb','options','masks','rest')
d.headall <- bind_rows(d.zindiv %>% 
                        filter(pos_type%in%pos_type_list) %>%
                        mutate(pos_type=factor(pos_type,levels=pos_type_list)) %>%
                        mutate(rep_type='transformation'),
                       d.key %>%
                         filter(pos_type%in%pos_type_list) %>%
                         mutate(pos_type=factor(pos_type,levels=pos_type_list)),
                       d.val %>%
                         filter(pos_type%in%pos_type_list) %>%
                         mutate(pos_type=factor(pos_type,levels=pos_type_list))
                        )
d.headall %>% head()
```

# Bootstrap 

can take a while when nboot is big

```{r,message=FALSE}
d.head_all.boot <- d.headall %>%
  group_by(cue_type,layer_id,head_id,rep_type,pos_type) %>%
  tidyboot_mean(effect_ave, nboot = 10) %>%
  rename(y=empirical_stat)
write.csv(d.head_all.boot,file=str_glue("headall_boot_{model_name}.csv"),row.names=FALSE)
d.head_all.boot <- read_csv(str_glue("headall_boot_{model_name}.csv"))
```

Examine effects at specific heads

```{r}
t.vals.all <- d.headall %>%
  filter(cue_type == 'context') %>%
  group_by(cue_type, layer_id, head_id, rep_type, pos_type) %>%
  summarize(p.val = t.test(effect_ave)$p.value,
            t.val = t.test(effect_ave)$statistic)

# Head 11
t.vals.all %>%
  filter(p.val < 0.000001) %>%
  filter(head_id %in% c(11)) 
 
# Head 8
t.vals.all %>%
  filter(p.val < 0.000001) %>%
  filter(head_id %in% c(8), layer_id %in% c(9, 10))
   
# Head 45
t.vals.all %>%
  filter(p.val < 0.000001) %>%
  filter(head_id %in% c(45))

# Head 53
t.vals.all %>%
  filter(p.val < 0.000001) %>%
  filter(head_id %in% c(53))

# Head 60
t.vals.all %>%
  filter(p.val < 0.000001) %>%
  filter(head_id %in% c(60))
```



# Comparing verb vs context

grid with heads as columns and layers as rows with heads marked by whether they are causally implicated for verb, context, or both.

```{r}
tvals.raw <- d.zindiv %>%
    group_by(layer_id, cue_type, head_id, pos_type) %>%
    summarize(p.val = t.test(effect_ave)$p.value,
              t.val = t.test(effect_ave)$statistic,
              effect = mean(effect_ave)) 

threshold <- 0.01/64/12/3
tvals.clean <- tvals.raw %>%
  select(layer_id,head_id,pos_type,p.val,cue_type, effect) %>%
  pivot_wider(names_from = c('cue_type'), values_from = c('p.val', 'effect')) %>%
  ungroup() %>%
  mutate(combination = case_when(p.val_verb > threshold & p.val_context <= threshold  ~ 'context_only',
                                    p.val_verb <= threshold & p.val_context > threshold ~ 'syntax_only',
                                    p.val_verb <= threshold & p.val_context <= threshold ~ 'both',
                                    TRUE ~ 'neither')) 
  
first_context_layer <- tvals.clean %>%
  filter(combination == 'context_only') %>%
  filter(!(pos_type %in% c('period', 'cls-sep', 'context', 'verb'))) %>%
  group_by(head_id, pos_type) %>%
  summarize(layer_of_first_context = min(layer_id)) %>%
  ungroup() %>%
  complete(head_id, pos_type, fill = list(layer_of_first_context = 13)) 
  
tvals.clean %>%
  left_join(first_context_layer) %>%
  filter(!(pos_type %in% c('period', 'cls-sep', 'context', 'verb'))) %>%
  filter(combination %in% c('context_only', 'both', 'syntax_only')) %>%
  replace_na(list(layer_of_first_context = 13)) %>%
  ungroup() %>%
  mutate(head_id = as.factor(head_id),
         head_id = fct_reorder(head_id, layer_of_first_context, .fun = mean, .desc = T),
         pos_type = fct_relevel(pos_type, 'rest')) %>%
  # rowwise() %>%
  # mutate(effect_diff = min(0.1, max(-0.1, effect_context - effect_verb)),
  #        min_p.val = 1 - min(p.val_context, p.val_verb)) %>%
  filter(layer_id > 11) %>%
  group_by(head_id) %>%
  filter(any(combination != 'both')) %>%
  ggplot(aes(x = layer_id, y = head_id, fill = combination)) +
    geom_tile(size = .5) +
    facet_grid( ~ pos_type) +
    scale_fill_colorblind() +
    scale_x_continuous(breaks = c(12,14,16,18,20,22,24)) +
    theme_few() 

ggsave(str_glue('head-specificity_{model_name}.pdf'), units = 'in', width = 5, height = 6)

```


## Make plots

```{r}
bar_center <- -0.006
bar_height <- 0.009
t.vals.all <- d.headall %>%
  group_by(cue_type, layer_id, head_id, rep_type, pos_type) %>%
  summarize(p.val = t.test(effect_ave)$p.value,
            t.val = t.test(effect_ave)$statistic) %>%
  mutate(p.log=(-log10(p.val))) %>%
  mutate(y = 0) %>%
  mutate(y = replace(y,pos_type==pos_type_list[1],bar_center-4*bar_height)) %>%
  mutate(y = replace(y,pos_type==pos_type_list[2],bar_center-3*bar_height)) %>%
  mutate(y = replace(y,pos_type==pos_type_list[3],bar_center-2*bar_height)) %>%
  mutate(y = replace(y,pos_type==pos_type_list[4],bar_center-bar_height)) %>%
  mutate(y = replace(y,pos_type==pos_type_list[5],bar_center)) %>%
  mutate(alpha = 0) %>%
  mutate(alpha = replace(alpha,p.log>-log10(0.05/12/64/5),0.2)) %>%
  mutate(alpha = replace(alpha,p.log>-log10(0.01/12/64/5),0.4)) %>%
  mutate(alpha = replace(alpha,p.log>-log10(0.005/12/64/5),0.6)) %>%
  mutate(alpha = replace(alpha,p.log>-log10(0.001/12/64/5),0.8)) %>%
  select(cue_type,layer_id,head_id,rep_type,pos_type,y,alpha,p.val)
write.csv(t.vals.all,file=str_glue("tvals_all_{model_name}.csv"),row.names=FALSE)
```

```{r,message=FALSE}
t.vals.all <- read_csv(str_glue("tvals_all_{model_name}.csv"))
t.vals.all
```

```{r}
d.headall.plot <- bind_rows(d.head_all.boot %>% 
                              select(cue_type,layer_id,head_id,rep_type,pos_type,y,ci_lower,ci_upper) %>%
                              mutate(plot_type='line'),
                            t.vals.all %>%
                              mutate(plot_type='tile'))
```

```{r}
if (model_name=="albert-xxlarge-v2") {
  num_heads = 64
} else {
  num_heads = 16
}
for (plot_head_id in 1:num_heads) {
#for (plot_head_id in c(3,8,11,16,17,21,23,24,26,28,29,35,37,40,42,45,46,48,50,51,53,55,56,58,60)) {
  for (plot_cue_type in c("context","verb")) {
    d.head <- d.headall.plot %>% 
      filter(cue_type==plot_cue_type) %>%
      filter(head_id==plot_head_id) %>%
      #mutate(rep_type=factor(rep_type,levels=c('transformation','query','key','value'))) %>%
      mutate(rep_type=factor(rep_type,levels=c('transformation','key','value'))) %>%
      mutate(plot_type=factor(plot_type,levels=c('tile','line'))) %>%
      mutate(pos_type=factor(pos_type,levels=pos_type_list))
    
    d.head %>%
      ggplot(aes(x=as.factor(layer_id), y=y, group=pos_type)) +
      geom_hline(yintercept=0) +
      geom_tile(data = subset(d.head, plot_type == 'tile'),
                height=bar_height,width=1,
                #aes(alpha=alpha,color="white",fill=pos_type)) +
                aes(alpha=alpha,fill=pos_type)) +
      geom_line(data = subset(d.head, plot_type == 'line'),
                aes(color=pos_type),linewidth=1.2) +
      geom_ribbon(data = subset(d.head, plot_type == 'line'),
                    aes(ymin=ci_lower, ymax=ci_upper, fill=pos_type),alpha = 0.2, color=NA,) +
      theme_few() +
      scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
      scale_fill_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
      scale_alpha(limits = c(0.0, 0.8)) +
      ylim(-0.05,NA) + 
      labs(x = 'Layer', y ='Effect') +
      guides(color=FALSE,alpha=FALSE,fill=guide_legend(ncol=5,order=1)) +
      facet_grid(plot_type~rep_type,scales = "free_y") +
      force_panelsizes(rows = c(unit(0.6,"in"), unit(3.0,"in")),
                       cols = c(unit(2.5,"in"),unit(2.5,"in"), unit(2.5,"in"))) +
      theme(legend.position = 'top', legend.title = element_blank(), legend.box="vertical",
            axis.text.x=element_text(size=10), axis.text.y=element_text(size=14), axis.title=element_text(size=18),
            strip.text.x=element_text(size=16), legend.text=element_text(size=16), strip.text.y=element_blank(),
            axis.line = element_line(colour = "black"),
            panel.border = element_blank(),panel.background = element_blank())
    ggsave(paste0('headwise/',model_name,'/all/alpha/head_',plot_head_id,'_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 7.5, height = 3.6)
  }
}
```

```{r}
show_cue_type <- "context"
show_head_id <- 44
show_pos_type <- "context"
show_rep_type <- "key"
t.vals.all %>% filter((cue_type==show_cue_type)&(head_id==show_head_id)&(pos_type==show_pos_type)&(rep_type==show_rep_type))
```

```{r}
show_cue_type <- "context"
show_head_id <- 44
show_pos_type <- "context"
show_rep_type <- "key"
d.head_all.boot %>% filter((cue_type==show_cue_type)&(head_id==show_head_id)&(pos_type==show_pos_type)&(rep_type==show_rep_type))
```

# 1.4.1: z rep

```{r}
pos_type_list <- c('context','verb','options','masks','rest')
for (plot_cue_type in c("context","verb")) {
d.zindiv %>%
    filter(pos_type%in%pos_type_list) %>%
    mutate(pos_type=factor(pos_type,levels=pos_type_list)) %>%
    filter(cue_type==plot_cue_type) %>%
    group_by(head_id, layer_id, pos_type) %>%
    tidyboot_mean(effect_ave, nboot = 10) %>%
    ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = pos_type, group = pos_type, fill=pos_type)) +
    geom_hline(yintercept=0) +
    geom_line(linewidth=0.8) + 
    geom_ribbon(aes(ymin=ci_lower, ymax=ci_upper), alpha = 0.2, color=NA,) +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    scale_fill_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    facet_wrap( ~ head_id) +
    theme_few() +
    labs(x = 'Layer', y ='Effect') +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=7),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
          strip.text=element_text(size=10), legend.text=element_text(size=16))
ggsave(paste0('supps/',model_name,'/zrep_all_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 13.5, height = 16)
}
```
```{r}
pos_type_list <- c('context','verb','options','masks','rest')
for (plot_cue_type in c("context","verb")) {
d.zindiv %>%
    filter(pos_type%in%pos_type_list) %>%
    mutate(pos_type=factor(pos_type,levels=pos_type_list)) %>%
    filter(cue_type==plot_cue_type) %>%
    group_by(layer_id, head_id, pos_type) %>%
    tidyboot_mean(effect_ave, nboot = 10) %>%
    ggplot(aes(x = head_id, y = empirical_stat, color = pos_type, group = pos_type, fill=pos_type)) +
    geom_hline(yintercept=0) +
    geom_line(linewidth=0.8) + 
    geom_ribbon(aes(ymin=ci_lower, ymax=ci_upper), alpha = 0.2, color=NA,) +
    scale_x_continuous(breaks = c(1,3,5,7,9,11,13,15)) +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    scale_fill_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    facet_grid(pos_type ~ layer_id, scales = "free_y") +
    theme_few() +
    labs(x = 'Layer', y ='Effect') +
    theme(aspect.ratio = 2,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=7),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
          strip.text=element_text(size=10), legend.text=element_text(size=16))
ggsave(paste0('supps/',model_name,'/zrep_all_flat_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 18, height = 9)
}
```
```{r}
d.zindiv.max <- d.zindiv %>%
    filter(pos_type%in%pos_type_list) %>%
    mutate(pos_type=factor(pos_type,levels=pos_type_list)) %>%
    group_by(cue_type, layer_id, head_id, pos_type) %>%
    tidyboot_mean(effect_ave, nboot = 10) %>%
    group_by(cue_type, layer_id, pos_type) %>%
    summarize(value = max(empirical_stat))
```

```{r}
pos_type_list <- c('context','verb','options','masks','rest')
for (plot_cue_type in c("context","verb")) {
d.zindiv %>%
    filter(pos_type%in%pos_type_list) %>%
    mutate(pos_type=factor(pos_type,levels=pos_type_list)) %>%
    filter(cue_type==plot_cue_type) %>%
    group_by(layer_id, head_id, pos_type) %>%
    tidyboot_mean(effect_ave, nboot = 10) %>%
    ggplot(aes(x = layer_id, y = empirical_stat, color = pos_type, group = head_id, fill=pos_type)) +
    geom_hline(yintercept=0) +
    #geom_vline(aes(xintercept=layer_id-0.5), linetype=2, color="grey") +
    #geom_segment(data = d.zindiv.max %>% filter(cue_type==plot_cue_type), 
    #          aes(x=layer_id-0.2,xend=layer_id+0.2,y=value,yend=value,color=pos_type,group=pos_type,fill=pos_type),
    #          linewidth=1.0) +
    geom_line(data = d.zindiv.max %>% filter(cue_type==plot_cue_type), 
              aes(x=layer_id,y=value,color=pos_type,group=pos_type,fill=pos_type),linewidth=1.0) +
    #geom_smooth(data = d.zindiv.max %>% filter(cue_type==plot_cue_type), span=0.3,
    #          aes(x=layer_id,y=value,color=pos_type,group=pos_type,fill=pos_type),
    #          linewidth=1.0) +
    #geom_step(data = d.zindiv.max %>% filter(cue_type==plot_cue_type), 
    #          aes(x = layer_id-0.5, y = value, color = pos_type, group = pos_type, fill = pos_type)) +
    #geom_rect(aes(xmin = time, xmax = lead(time), ymin = 0, ymax = prob), alpha = 0.4)
    geom_jitter(size=1.0, width=0.25, alpha = 0.3, shape=16) + 
    #geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=NA,size=0.5,linetype='solid',position = position_dodge(width = 0.3),alpha = 0.1) +
    scale_x_continuous(breaks = c(1,3,5,7,9,11,13,15,17,19,21,23)) +
    scale_y_continuous(breaks = c(-0.4,0.0,0.4,0.8)) +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    scale_fill_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    facet_wrap(vars(pos_type),ncol=1) +
    theme_few() +
    labs(x = 'Layer', y ='Effect') +
    theme(aspect.ratio = 0.1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=10),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
          strip.text=element_blank(), legend.text=element_text(size=16))
ggsave(paste0('supps/',model_name,'/zrep_all_agg_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 6, height = 6)
}
```


```{r}
pos_type_list <- c('context','verb','options','masks','rest')
for (plot_cue_type in c("context","verb")) {
d.zindiv %>%
    filter(pos_type%in%pos_type_list) %>%
    mutate(pos_type=factor(pos_type,levels=pos_type_list)) %>%
    filter(cue_type==plot_cue_type) %>%
    group_by(layer_id, head_id, pos_type) %>%
    tidyboot_mean(effect_ave, nboot = 10) %>%
    group_by(layer_id, pos_type) %>%
    summarize(value = max(empirical_stat)) %>%
    ggplot(aes(x = layer_id, y = pos_type, height = value, color = pos_type, group = pos_type, fill=pos_type)) +
    #geom_hline(yintercept=0) +
    #geom_line(linewidth=0.8) + 
    geom_ridgeline() +
    #geom_ribbon(aes(ymin=ci_lower, ymax=ci_upper), alpha = 0.2, color=NA,) +
    scale_x_continuous(breaks = c(1,5,9,13,17,21)) +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    scale_fill_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    #facet_grid(pos_type ~ layer_id, scales = "free_y") +
    theme_few() +
    labs(x = 'Layer', y ='Effect') +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=7),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
          strip.text=element_text(size=10), legend.text=element_text(size=16))
ggsave(paste0('supps/',model_name,'/zrep_all_agg_ridge_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 6, height = 6)
}
```


# 1.4.3 Value

```{r}
d.val %>% pull(cue_type) %>% unique()
d.val %>% pull(pos_type) %>% unique()
```


```{r}
pos_type_list <- c('context','verb','options','masks','rest')
for (plot_cue_type in c("context","verb")) {
d.val %>%
  filter(pos_type%in%pos_type_list) %>%
  mutate(pos_type=factor(pos_type,levels=pos_type_list)) %>%
  filter(cue_type==plot_cue_type) %>%
  group_by(head_id, layer_id, pos_type) %>%
  tidyboot_mean(effect_ave, nboot = 10) %>%
  ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = pos_type, group = pos_type, fill = pos_type)) +
    geom_hline(yintercept=0) +
    geom_line(linewidth=0.8) + 
    #,position = position_dodge(width = 0.3)) +
    #geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.5,size=0.5,linetype='solid',position = position_dodge(width = 0.3)) +
    geom_ribbon(aes(ymin=ci_lower, ymax=ci_upper), alpha = 0.2, color=NA,) +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    scale_fill_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    facet_wrap( ~ head_id) +
    theme_few() +
    labs(x = 'Layer', y ='Effect') +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=7),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
          strip.text=element_text(size=10), legend.text=element_text(size=16))
ggsave(paste0('supps/',model_name,'/value_all_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 13.5, height = 16)
}
```

```{r}
pos_type_list <- c('context','verb','options','masks','rest')
for (plot_cue_type in c("context","verb")) {
d.val %>%
    filter(pos_type%in%pos_type_list) %>%
    mutate(pos_type=factor(pos_type,levels=pos_type_list)) %>%
    filter(cue_type==plot_cue_type) %>%
    group_by(layer_id, head_id, pos_type) %>%
    tidyboot_mean(effect_ave, nboot = 10) %>%
    ggplot(aes(x = head_id, y = empirical_stat, color = pos_type, group = pos_type, fill=pos_type)) +
    geom_hline(yintercept=0) +
    geom_line(linewidth=0.8) + 
    geom_ribbon(aes(ymin=ci_lower, ymax=ci_upper), alpha = 0.2, color=NA,) +
    scale_x_continuous(breaks = c(1,3,5,7,9,11,13,15)) +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    scale_fill_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    facet_grid(pos_type ~ layer_id, scales = "free_y") +
    theme_few() +
    labs(x = 'Layer', y ='Effect') +
    theme(aspect.ratio = 2,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=7),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
          strip.text=element_text(size=10), legend.text=element_text(size=16))
ggsave(paste0('supps/',model_name,'/value_all_flat_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 18, height = 9)
}
```

```{r}
d.val.max <- d.val %>%
    filter(pos_type%in%pos_type_list) %>%
    mutate(pos_type=factor(pos_type,levels=pos_type_list)) %>%
    group_by(cue_type, layer_id, head_id, pos_type) %>%
    tidyboot_mean(effect_ave, nboot = 10) %>%
    group_by(cue_type, layer_id, pos_type) %>%
    summarize(value = max(empirical_stat))
```

```{r}
pos_type_list <- c('context','verb','options','masks','rest')
for (plot_cue_type in c("context","verb")) {
d.val %>%
    filter(pos_type%in%pos_type_list) %>%
    mutate(pos_type=factor(pos_type,levels=pos_type_list)) %>%
    filter(cue_type==plot_cue_type) %>%
    group_by(layer_id, head_id, pos_type) %>%
    tidyboot_mean(effect_ave, nboot = 10) %>%
    ggplot(aes(x = layer_id, y = empirical_stat, color = pos_type, group = head_id, fill=pos_type)) +
    geom_hline(yintercept=0) +
    #geom_vline(aes(xintercept=layer_id-0.5), linetype=2, color="grey") +
    #geom_segment(data = d.zindiv.max %>% filter(cue_type==plot_cue_type), 
    #          aes(x=layer_id-0.2,xend=layer_id+0.2,y=value,yend=value,color=pos_type,group=pos_type,fill=pos_type),
    #          linewidth=1.0) +
    geom_line(data = d.val.max %>% filter(cue_type==plot_cue_type), 
              aes(x=layer_id,y=value,color=pos_type,group=pos_type,fill=pos_type),linewidth=1.0) +
    #geom_smooth(data = d.zindiv.max %>% filter(cue_type==plot_cue_type), span=0.3,
    #          aes(x=layer_id,y=value,color=pos_type,group=pos_type,fill=pos_type),
    #          linewidth=1.0) +
    #geom_step(data = d.zindiv.max %>% filter(cue_type==plot_cue_type), 
    #          aes(x = layer_id-0.5, y = value, color = pos_type, group = pos_type, fill = pos_type)) +
    #geom_rect(aes(xmin = time, xmax = lead(time), ymin = 0, ymax = prob), alpha = 0.4)
    geom_jitter(size=1.0, width=0.25, alpha = 0.3, shape=16) + 
    #geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=NA,size=0.5,linetype='solid',position = position_dodge(width = 0.3),alpha = 0.1) +
    scale_x_continuous(breaks = c(1,3,5,7,9,11,13,15,17,19,21,23)) +
    scale_y_continuous(breaks = c(-0.2,0.0,0.2,0.4,0.6)) +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    scale_fill_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    facet_wrap(vars(pos_type),ncol=1) +
    theme_few() +
    labs(x = 'Layer', y ='Effect') +
    theme(aspect.ratio = 0.1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=10),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
          strip.text=element_blank(), legend.text=element_text(size=16))
ggsave(paste0('supps/',model_name,'/value_all_agg_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 6, height = 6)
}
```


```{r}
pos_type_list <- c('context','verb','options','masks','rest')
for (plot_cue_type in c("context","verb")) {
d.val %>%
    filter(pos_type%in%pos_type_list) %>%
    mutate(pos_type=factor(pos_type,levels=pos_type_list)) %>%
    filter(cue_type==plot_cue_type) %>%
    group_by(layer_id, head_id, pos_type) %>%
    tidyboot_mean(effect_ave, nboot = 10) %>%
    group_by(layer_id, pos_type) %>%
    summarize(value = max(empirical_stat)) %>%
    ggplot(aes(x = layer_id, y = pos_type, height = value, color = pos_type, group = pos_type, fill=pos_type)) +
    #geom_hline(yintercept=0) +
    #geom_line(linewidth=0.8) + 
    geom_ridgeline() +
    #geom_ribbon(aes(ymin=ci_lower, ymax=ci_upper), alpha = 0.2, color=NA,) +
    scale_x_continuous(breaks = c(1,5,9,13,17,21)) +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    scale_fill_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    #facet_grid(pos_type ~ layer_id, scales = "free_y") +
    theme_few() +
    labs(x = 'Layer', y ='Effect') +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=7),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
          strip.text=element_text(size=10), legend.text=element_text(size=16))
ggsave(paste0('supps/',model_name,'/value_all_agg_ridge_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 6, height = 6)
}
```

# Query
```{r}
pos_type_list <- c('context','verb','options','masks','rest')
for (plot_cue_type in c("context","verb")) {
d.qry %>%
  filter(pos_type%in%pos_type_list) %>%
  mutate(pos_type=factor(pos_type,levels=pos_type_list)) %>%
  filter(cue_type==plot_cue_type) %>%
  group_by(head_id, layer_id, pos_type) %>%
  tidyboot_mean(effect_ave, nboot = 10) %>%
  ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = pos_type, group = pos_type, fill=pos_type)) +
    geom_hline(yintercept=0) +
    geom_line(size=0.8) +
    #+,position = position_dodge(width = 0.3)) +
    #geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.5,size=0.5,linetype='solid',position = position_dodge(width = 0.3)) +
    geom_ribbon(aes(ymin=ci_lower, ymax=ci_upper), alpha = 0.2, color=NA,) +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    scale_fill_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    facet_wrap( ~ head_id) +
    theme_few() +
    labs(x = 'Layer', y ='Effect') +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=7),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
          strip.text=element_text(size=10), legend.text=element_text(size=16))
ggsave(paste0('supps/',model_name,'/query_all_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 13.5, height = 16)
}
```

```{r}
pos_type_list <- c('context','verb','options','masks','rest')
for (plot_cue_type in c("context","verb")) {
d.qry %>%
    filter(pos_type%in%pos_type_list) %>%
    mutate(pos_type=factor(pos_type,levels=pos_type_list)) %>%
    filter(cue_type==plot_cue_type) %>%
    group_by(layer_id, head_id, pos_type) %>%
    tidyboot_mean(effect_ave, nboot = 10) %>%
    ggplot(aes(x = head_id, y = empirical_stat, color = pos_type, group = pos_type, fill=pos_type)) +
    geom_hline(yintercept=0) +
    geom_line(linewidth=0.8) + 
    geom_ribbon(aes(ymin=ci_lower, ymax=ci_upper), alpha = 0.2, color=NA,) +
    scale_x_continuous(breaks = c(1,3,5,7,9,11,13,15)) +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    scale_fill_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    facet_grid(pos_type ~ layer_id, scales = "free_y") +
    theme_few() +
    labs(x = 'Layer', y ='Effect') +
    theme(aspect.ratio = 2,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=7),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
          strip.text=element_text(size=10), legend.text=element_text(size=16))
ggsave(paste0('supps/',model_name,'/query_all_flat_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 18, height = 9)
}
```

```{r}
d.qry.max <- d.qry %>%
    filter(pos_type%in%pos_type_list) %>%
    mutate(pos_type=factor(pos_type,levels=pos_type_list)) %>%
    group_by(cue_type, layer_id, head_id, pos_type) %>%
    tidyboot_mean(effect_ave, nboot = 10) %>%
    group_by(cue_type, layer_id, pos_type) %>%
    summarize(value = max(empirical_stat))
```

```{r}
pos_type_list <- c('context','verb','options','masks','rest')
for (plot_cue_type in c("context","verb")) {
d.qry %>%
    filter(pos_type%in%pos_type_list) %>%
    mutate(pos_type=factor(pos_type,levels=pos_type_list)) %>%
    filter(cue_type==plot_cue_type) %>%
    group_by(layer_id, head_id, pos_type) %>%
    tidyboot_mean(effect_ave, nboot = 10) %>%
    ggplot(aes(x = layer_id, y = empirical_stat, color = pos_type, group = head_id, fill=pos_type)) +
    geom_hline(yintercept=0) +
    #geom_vline(aes(xintercept=layer_id-0.5), linetype=2, color="grey") +
    #geom_segment(data = d.zindiv.max %>% filter(cue_type==plot_cue_type), 
    #          aes(x=layer_id-0.2,xend=layer_id+0.2,y=value,yend=value,color=pos_type,group=pos_type,fill=pos_type),
    #          linewidth=1.0) +
    geom_line(data = d.qry.max %>% filter(cue_type==plot_cue_type), 
              aes(x=layer_id,y=value,color=pos_type,group=pos_type,fill=pos_type),linewidth=1.0) +
    #geom_smooth(data = d.zindiv.max %>% filter(cue_type==plot_cue_type), span=0.3,
    #          aes(x=layer_id,y=value,color=pos_type,group=pos_type,fill=pos_type),
    #          linewidth=1.0) +
    #geom_step(data = d.zindiv.max %>% filter(cue_type==plot_cue_type), 
    #          aes(x = layer_id-0.5, y = value, color = pos_type, group = pos_type, fill = pos_type)) +
    #geom_rect(aes(xmin = time, xmax = lead(time), ymin = 0, ymax = prob), alpha = 0.4)
    geom_jitter(size=1.0, width=0.25, alpha = 0.3, shape=16) + 
    #geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=NA,size=0.5,linetype='solid',position = position_dodge(width = 0.3),alpha = 0.1) +
    scale_x_continuous(breaks = c(1,3,5,7,9,11,13,15,17,19,21,23)) +
    scale_y_continuous(breaks = c(-0.2,0.0,0.2,0.4)) +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    scale_fill_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    facet_wrap(vars(pos_type),ncol=1) +
    theme_few() +
    labs(x = 'Layer', y ='Effect') +
    theme(aspect.ratio = 0.1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=10),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
          strip.text=element_blank(), legend.text=element_text(size=16))
ggsave(paste0('supps/',model_name,'/query_all_agg_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 6, height = 6)
}
```


```{r}
pos_type_list <- c('context','verb','options','masks','rest')
for (plot_cue_type in c("context","verb")) {
d.qry %>%
    filter(pos_type%in%pos_type_list) %>%
    mutate(pos_type=factor(pos_type,levels=pos_type_list)) %>%
    filter(cue_type==plot_cue_type) %>%
    group_by(layer_id, head_id, pos_type) %>%
    tidyboot_mean(effect_ave, nboot = 10) %>%
    group_by(layer_id, pos_type) %>%
    summarize(value = max(empirical_stat)) %>%
    ggplot(aes(x = layer_id, y = pos_type, height = value, color = pos_type, group = pos_type, fill=pos_type)) +
    #geom_hline(yintercept=0) +
    #geom_line(linewidth=0.8) + 
    geom_ridgeline() +
    #geom_ribbon(aes(ymin=ci_lower, ymax=ci_upper), alpha = 0.2, color=NA,) +
    scale_x_continuous(breaks = c(1,5,9,13,17,21)) +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    scale_fill_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    #facet_grid(pos_type ~ layer_id, scales = "free_y") +
    theme_few() +
    labs(x = 'Layer', y ='Effect') +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=7),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
          strip.text=element_text(size=10), legend.text=element_text(size=16))
ggsave(paste0('supps/',model_name,'/query_all_agg_ridge_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 6, height = 6)
}
```

# Key
```{r}
pos_type_list <- c('context','verb','options','masks','rest')
for (plot_cue_type in c("context","verb")) {
d.key %>%
  filter(pos_type%in%pos_type_list) %>%
  mutate(pos_type=factor(pos_type,levels=pos_type_list)) %>%
  filter(cue_type==plot_cue_type) %>%
  group_by(head_id, layer_id, pos_type) %>%
  tidyboot_mean(effect_ave, nboot = 10) %>%
  ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = pos_type, group = pos_type, fill=pos_type)) +
    geom_hline(yintercept=0) +
    geom_line(linewidth=0.8) +
    #,position = position_dodge(width = 0.3)) +
    #geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.5,size=0.5,linetype='solid',position = position_dodge(width = 0.3)) +
    geom_ribbon(aes(ymin=ci_lower, ymax=ci_upper), alpha = 0.2, color=NA,) +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    scale_fill_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    facet_wrap( ~ head_id) +
    theme_few() +
    labs(x = 'Layer', y ='Effect') +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=7),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
          strip.text=element_text(size=10), legend.text=element_text(size=16))
ggsave(paste0('supps/',model_name,'/key_all_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 13.5, height = 16)
}
```

```{r}
pos_type_list <- c('context','verb','options','masks','rest')
for (plot_cue_type in c("context","verb")) {
d.key %>%
    filter(pos_type%in%pos_type_list) %>%
    mutate(pos_type=factor(pos_type,levels=pos_type_list)) %>%
    filter(cue_type==plot_cue_type) %>%
    group_by(layer_id, head_id, pos_type) %>%
    tidyboot_mean(effect_ave, nboot = 10) %>%
    ggplot(aes(x = head_id, y = empirical_stat, color = pos_type, group = pos_type, fill=pos_type)) +
    geom_hline(yintercept=0) +
    geom_line(linewidth=0.8) + 
    geom_ribbon(aes(ymin=ci_lower, ymax=ci_upper), alpha = 0.2, color=NA,) +
    scale_x_continuous(breaks = c(1,3,5,7,9,11,13,15)) +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    scale_fill_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    facet_grid(pos_type ~ layer_id, scales = "free_y") +
    theme_few() +
    labs(x = 'Layer', y ='Effect') +
    theme(aspect.ratio = 2,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=7),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
          strip.text=element_text(size=10), legend.text=element_text(size=16))
ggsave(paste0('supps/',model_name,'/key_all_flat_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 18, height = 9)
}
```

```{r}
d.key.max <- d.key %>%
    filter(pos_type%in%pos_type_list) %>%
    mutate(pos_type=factor(pos_type,levels=pos_type_list)) %>%
    group_by(cue_type, layer_id, head_id, pos_type) %>%
    tidyboot_mean(effect_ave, nboot = 10) %>%
    group_by(cue_type, layer_id, pos_type) %>%
    summarize(value = max(empirical_stat))
```

```{r}
pos_type_list <- c('context','verb','options','masks','rest')
for (plot_cue_type in c("context","verb")) {
d.key %>%
    filter(pos_type%in%pos_type_list) %>%
    mutate(pos_type=factor(pos_type,levels=pos_type_list)) %>%
    filter(cue_type==plot_cue_type) %>%
    group_by(layer_id, head_id, pos_type) %>%
    tidyboot_mean(effect_ave, nboot = 10) %>%
    ggplot(aes(x = layer_id, y = empirical_stat, color = pos_type, group = head_id, fill=pos_type)) +
    geom_hline(yintercept=0) +
    #geom_vline(aes(xintercept=layer_id-0.5), linetype=2, color="grey") +
    #geom_segment(data = d.zindiv.max %>% filter(cue_type==plot_cue_type), 
    #          aes(x=layer_id-0.2,xend=layer_id+0.2,y=value,yend=value,color=pos_type,group=pos_type,fill=pos_type),
    #          linewidth=1.0) +
    geom_line(data = d.key.max %>% filter(cue_type==plot_cue_type), 
              aes(x=layer_id,y=value,color=pos_type,group=pos_type,fill=pos_type),linewidth=1.0) +
    #geom_smooth(data = d.zindiv.max %>% filter(cue_type==plot_cue_type), span=0.3,
    #          aes(x=layer_id,y=value,color=pos_type,group=pos_type,fill=pos_type),
    #          linewidth=1.0) +
    #geom_step(data = d.zindiv.max %>% filter(cue_type==plot_cue_type), 
    #          aes(x = layer_id-0.5, y = value, color = pos_type, group = pos_type, fill = pos_type)) +
    #geom_rect(aes(xmin = time, xmax = lead(time), ymin = 0, ymax = prob), alpha = 0.4)
    geom_jitter(size=1.0, width=0.25, alpha = 0.3, shape=16) + 
    #geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=NA,size=0.5,linetype='solid',position = position_dodge(width = 0.3),alpha = 0.1) +
    scale_x_continuous(breaks = c(1,3,5,7,9,11,13,15,17,19,21,23)) +
    scale_y_continuous(breaks = c(-0.2,0.0,0.2,0.4)) +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    scale_fill_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    facet_wrap(vars(pos_type),ncol=1) +
    theme_few() +
    labs(x = 'Layer', y ='Effect') +
    theme(aspect.ratio = 0.1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=10),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
          strip.text=element_blank(), legend.text=element_text(size=16))
ggsave(paste0('supps/',model_name,'/key_all_agg_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 6, height = 6)
}
```


```{r}
pos_type_list <- c('context','verb','options','masks','rest')
for (plot_cue_type in c("context","verb")) {
d.key %>%
    filter(pos_type%in%pos_type_list) %>%
    mutate(pos_type=factor(pos_type,levels=pos_type_list)) %>%
    filter(cue_type==plot_cue_type) %>%
    group_by(layer_id, head_id, pos_type) %>%
    tidyboot_mean(effect_ave, nboot = 10) %>%
    group_by(layer_id, pos_type) %>%
    summarize(value = max(empirical_stat)) %>%
    ggplot(aes(x = layer_id, y = pos_type, height = value, color = pos_type, group = pos_type, fill=pos_type)) +
    #geom_hline(yintercept=0) +
    #geom_line(linewidth=0.8) + 
    geom_ridgeline() +
    #geom_ribbon(aes(ymin=ci_lower, ymax=ci_upper), alpha = 0.2, color=NA,) +
    scale_x_continuous(breaks = c(1,5,9,13,17,21)) +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    scale_fill_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    #facet_grid(pos_type ~ layer_id, scales = "free_y") +
    theme_few() +
    labs(x = 'Layer', y ='Effect') +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=7),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
          strip.text=element_text(size=10), legend.text=element_text(size=16))
ggsave(paste0('supps/',model_name,'/key_all_agg_ridge_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 6, height = 6)
}
```