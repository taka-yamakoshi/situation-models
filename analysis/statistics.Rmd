---
title: "R Notebook"
output: html_notebook
---

# Import dependencies

```{r}
library(tidyverse)
library(here)
library(ggthemes)
library(tidyboot)
```

```{r}
colorblind_pal()(8)
```
"#E69F00","#D55E00","#56B4E9","#009E73","#000000"
# Import data

```{r,message=FALSE}
d <- read_csv(here('results/combined_effect_ave_all/combined_effect_ave_layer-query-key-value_multihead.csv')) %>%
  filter(head_id==0) %>%
  separate(pair_id, into = c('prefix', 'pair_id'))
```

How many sentences?

```{r}
d %>% pull(cue_type) %>% unique()
d %>% pull(pair_id) %>% unique()
d %>% pull(pos_type) %>% unique()
```

# 1.1: Performance

```{r}
d %>%
  #filter(cue_type %in% c('context', 'verb')) %>%
  group_by(cue_type, pair_id) %>%
  summarize(acc = mean(original_score)) %>%
  group_by(cue_type) %>%
  summarize(n = sum(acc))
```

# 1.2: Layer-wise intervention
```{r}
d.layer <- d %>%
  filter(cue_type %in% c('context','verb','context_verb')) %>%
  filter(pos_type %in% c('context','verb','options', 'masks', 'rest')) %>%
  mutate(cue_type = replace(cue_type,cue_type=='context_verb','context+verb')) %>%
  mutate(cue_type=factor(cue_type,levels=c('context','verb','context+verb'))) %>%
  mutate(pos_type=factor(pos_type,levels=c('context','verb','options','masks','rest'))) %>%
  mutate(layer_id = layer_id+1)
```

```{r}
d.layer %>%
  filter(original_score) %>%
  group_by(cue_type, layer_id, pos_type) %>%
  #summarize(effect_ave = mean(effect_ave)) %>%
  tidyboot_mean(effect_ave, nboot = 1000) %>%
  ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = pos_type, group = pos_type)) +
    geom_line(size=1.2,position = position_dodge(width = 0.4)) +
    geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.1,size=0.8,linetype='solid',position = position_dodge(width = 0.4)) +
    theme_few() +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    labs(x = 'Layer', y ='Effect') +
    geom_hline(yintercept=0) +
    facet_wrap(~ cue_type, scales="free_y") +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=10),axis.text.y=element_text(size=14), axis.title=element_text(size=18),
          strip.text=element_text(size=16), legend.text=element_text(size=16)) +
ggsave('layer.pdf', units = 'in', width = 9, height = 4)
```

```{r}
d.layer %>%
  filter(original_1<0 & original_2>0 & original_1<original_2) %>%
  group_by(cue_type, layer_id, pos_type) %>%
  #summarize(effect_ave = mean(effect_ave)) %>%
  tidyboot_mean(effect_ave, nboot = 1000) %>%
  ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = pos_type, group = pos_type)) +
    geom_line(size=1.2,position = position_dodge(width = 0.4)) +
    geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.1,size=0.8,linetype='solid',position = position_dodge(width = 0.4)) +
    theme_few() +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    labs(x = 'Layer', y ='Effect') +
    geom_hline(yintercept=0) +
    facet_wrap(~ cue_type, scales="free_y") +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=10),axis.text.y=element_text(size=14), axis.title=element_text(size=18),
          strip.text=element_text(size=16), legend.text=element_text(size=16)) +
ggsave('layer_split_1_0_2.pdf', units = 'in', width = 9, height = 4)
```

```{r}
d %>%
  filter(cue_type %in% c('context','verb','context_verb')) %>%
  filter(pos_type %in% c('period','cls-sep')) %>%
  mutate(cue_type = replace(cue_type,cue_type=='context_verb','context+verb')) %>%
  mutate(cue_type=factor(cue_type,levels=c('context','verb','context+verb'))) %>%
  mutate(pos_type=factor(pos_type,levels=c('period','cls-sep'))) %>%
  mutate(layer_id = layer_id+1) %>%
  filter(original_score) %>%
  group_by(cue_type, layer_id, pos_type) %>%
  #summarize(effect_ave = mean(effect_ave)) %>%
  tidyboot_mean(effect_ave, nboot = 1000) %>%
  ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = pos_type, group = pos_type)) +
    geom_line(size=1.2,position = position_dodge(width = 0.4)) +
    geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.1,size=0.8,linetype='solid',position = position_dodge(width = 0.4)) +
    theme_few() +
    scale_color_manual(values=c("#0072B2","#CC79A7")) +
    labs(x = 'Layer', y ='Effect') +
    geom_hline(yintercept=0) +
    facet_wrap(~ cue_type, scales="free_y") +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=10),axis.text.y=element_text(size=14), axis.title=element_text(size=18),
          strip.text=element_text(size=16), legend.text=element_text(size=16)) +
ggsave('layer_period_cls-sep.pdf', units = 'in', width = 9, height = 4)
```



# Statistical analysis

Run (paired) t-tests at each layer to test where differences between sentence pairs emerge

```{r}
d %>%
  #filter(original_score) %>%
  filter(cue_type %in% c('context', 'verb')) %>%
  filter(pos_type == 'options') %>%
  group_by(pair_id, cue_type, layer_id, pos_type) %>%
  summarize(effect_ave = mean(effect_ave, rm.na = T)) %>%
  spread(cue_type, effect_ave) %>%
  group_by(layer_id) %>%
  summarize(p.val = t.test(context, verb, paired = T)$p.value,
            diff_size = mean(context - verb)) %>%
  mutate(significance_level = case_when(p.val < 0.001 ~ '***', p.val < 0.01 ~ '**', p.val < 0.05 ~ '*', TRUE ~ 'n.s.'))
```

Run single-sample t-tests at each layer to test where differences from 0 emerge

```{r}
d %>%
  filter(cue_type %in% c('context', 'verb')) %>%
  filter(pos_type == 'options') %>%
  group_by(pair_id, cue_type, layer_id, pos_type) %>%
  summarize(effect_ave = mean(effect_ave, rm.na = T)) %>%
  group_by(layer_id, cue_type) %>%
  summarize(p.val = t.test(effect_ave)$p.value) %>%
  mutate(significance_level = case_when(p.val < 0.001 ~ '***', p.val < 0.01 ~ '**', p.val < 0.05 ~ '*', TRUE ~ 'n.s.'))
```


# 1.3: Z-rep intervention (cumulative)

```{r,message=FALSE}
d.zrep <- read_csv(here('results/combined_effect_ave_all/combined_effect_ave_z_rep_cascade_multihead.csv')) %>%
  filter(head_id==0) %>%
  separate(pair_id, into = c('prefix', 'pair_id'))
```

```{r}
d.zrep %>% pull(cue_type) %>% unique()
d.zrep %>% pull(pos_type) %>% unique()
```

```{r}
d.zrep <- d.zrep %>%
  filter(pos_type %in% c('options', 'masks','rest')) %>%
  mutate(cue_type = replace(cue_type,cue_type=='context_verb','context+verb')) %>%
  mutate(cue_type=factor(cue_type,levels=c('context','verb','context+verb'))) %>%
  mutate(pos_type=factor(pos_type,levels=c('options','masks','rest'))) %>%
  mutate(layer_id = layer_id+1)
```

```{r}
d.zrep %>%
  filter(original_score) %>%
  group_by(cue_type, layer_id, pos_type) %>%
  #summarize(effect_ave = mean(effect_ave)) %>%
  tidyboot_mean(effect_ave, nboot = 1000) %>%
  ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = pos_type, group = pos_type)) +
    geom_hline(yintercept=0) +
    geom_line(size=1.2,position = position_dodge(width = 0.3)) +
    geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.1,size=0.8,linetype='solid',position = position_dodge(width = 0.3)) +
    theme_few() +
    scale_color_manual(values=c("#56B4E9","#009E73","#000000")) +
    labs(x = 'Layer', y ='Effect') +
    facet_wrap( ~ cue_type, scales="free_y") +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=10),axis.text.y=element_text(size=14), axis.title=element_text(size=18),
          strip.text=element_text(size=16), legend.text=element_text(size=16)) +
ggsave('zrep.pdf', units = 'in', width = 6, height = 4)
```


# 1.4: fine-grained analyses

```{r,message=FALSE}
d.zindiv <- read_csv(here('results/combined_effect_ave_all/combined_effect_ave_z_rep.csv'))
d.att <- read_csv(here('results/combined_effect_ave_all/combined_effect_ave_attention.csv'))
d.qnk <- read_csv(here('results/combined_effect_ave_all/combined_effect_ave_q_and_k.csv'))
d.val <- read_csv(here('results/combined_effect_ave_all/combined_effect_ave_value.csv'))
```

```{r}
d.zindiv <- d.zindiv %>%
  filter(original_score) %>%
  filter(pos_type%in%c('context','verb','options', 'masks', 'rest','period','cls-sep')) %>%
  mutate(pos_type=factor(pos_type,levels=c('context','verb','options', 'masks', 'rest','period','cls-sep'))) %>%
  mutate(layer_id=layer_id+1) %>%
  mutate(head_id=head_id+1)
d.attqnk <- bind_rows(d.att,d.qnk)
d.attqnk <- d.attqnk %>%
  filter(original_score) %>%
  filter(pos_type%in%c('all','masks-options','options-masks','rest-options','rest-masks',
                       'options-rest','masks-rest','context-rest','verb-rest')) %>%
  mutate(pos_type = replace(pos_type,pos_type=='all','attention')) %>%
  #mutate(pos_type = replace(pos_type,pos_type=="masks-options","query@options\n& key@masks")) %>%
  #mutate(pos_type = replace(pos_type,pos_type=="options-masks","query@masks\n& key@options")) %>%
  mutate(pos_type=factor(pos_type,levels=c('attention','masks-options','options-masks','rest-options','rest-masks',
                                           'options-rest','masks-rest','context-rest','verb-rest'))) %>%
  mutate(layer_id=layer_id+1) %>%
  mutate(head_id=head_id+1)
d.val <- d.val %>%
  filter(original_score) %>%
  filter(pos_type%in%c('context','verb','options','masks','rest','period','cls-sep')) %>%
  mutate(pos_type=factor(pos_type,levels=c('context','verb','options','masks','rest','period','cls-sep'))) %>%
  mutate(layer_id=layer_id+1) %>%
  mutate(head_id=head_id+1)
```

```{r}
d.zindiv %>% pull(cue_type) %>% unique()
d.zindiv %>% pull(pos_type) %>% unique()
d.att %>% pull(cue_type) %>% unique()
d.att %>% pull(pos_type) %>% unique()
d.qnk %>% pull(cue_type) %>% unique()
d.qnk %>% pull(pos_type) %>% unique()
d.val %>% pull(cue_type) %>% unique()
d.val %>% pull(pos_type) %>% unique()
```

```{r}
d.headall <- bind_rows(d.zindiv %>% 
                        filter(pos_type%in%c('options','masks','rest')) %>%
                        mutate(pos_type=factor(pos_type,levels=c('options','masks','rest'))) %>%
                        mutate(rep_type='z'),
                      d.attqnk,
                      d.val %>%
                        filter(pos_type%in%c('context','verb','options','masks','rest')) %>%
                        mutate(pos_type=factor(pos_type,levels=c('context','verb','options','masks','rest')))
                        )
d.headall <- d.headall %>%
  filter(original_score) %>%
  mutate(layer_id=layer_id+1) %>%
  mutate(head_id=head_id+1)
```

```{r}
for (plot_head_id in c(8,10,11,15,19,21,26,44,45,48,50,51,53)) {
for (plot_cue_type in c("context","verb")) {
d.headall %>%
    filter(cue_type==plot_cue_type) %>%
    filter(head_id==plot_head_id) %>%
    mutate(rep_type=factor(rep_type,levels=c('z','attention','value'))) %>%
    mutate(pos_type=factor(pos_type,levels=c('context','verb','options','masks','rest',
                                             'attention','query@options\n& key@masks','query@masks\n& key@options'))) %>%
  
    group_by(rep_type,pos_type,layer_id,head_id) %>%
    #summarize(effect_ave = mean(effect_ave)) %>%
    tidyboot_mean(effect_ave, nboot = 1000) %>%
    ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = pos_type, group = pos_type)) +
      geom_hline(yintercept=0) +
      geom_line(size=1.2,position = position_dodge(width = 0.3)) +
      geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.8,size=0.8,linetype='solid',position = position_dodge(width = 0.3)) +
      theme_few() +
      scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000",
                                  "#F0E442","#CC79A7","#0072B2")) +
      #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
      labs(x = 'Layer', y ='Effect') +
      guides(color=guide_legend(ncol=5)) +
      facet_wrap(vars(rep_type)) +
      theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(),
            axis.text.x=element_text(size=10),axis.text.y=element_text(size=14), axis.title=element_text(size=18),
            strip.text=element_text(size=16), legend.text=element_text(size=16)) +
  ggsave(paste('headwise/all/head_',plot_head_id,'_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 6, height = 4)
}}
```

# 1.4.1: z rep
```{r}
d.zindiv %>% pull(cue_type) %>% unique()
d.zindiv %>% pull(pos_type) %>% unique()
d.zindiv %>% pull(layer_id) %>% unique()
d.zindiv %>% pull(head_id) %>% unique()
d.zindiv %>% filter(cue_type=="verb") %>% pull(pair_id) %>% unique()
```

```{r}
for (plot_cue_type in c("context","verb")) {
d.zindiv %>%
  filter(cue_type==plot_cue_type) %>%
  group_by(head_id, layer_id, pos_type) %>%
  tidyboot_mean(effect_ave, nboot = 10) %>%
  ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = pos_type, group = pos_type)) +
    geom_hline(yintercept=0) +
    geom_line(size=0.8,position = position_dodge(width = 0.3)) +
    geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.5,size=0.5,linetype='solid',position = position_dodge(width = 0.3)) +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000","#0072B2","#CC79A7")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    facet_wrap( ~ head_id) +
    theme_few() +
    labs(x = 'Layer', y ='Effect') +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=7),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
          strip.text=element_text(size=10), legend.text=element_text(size=16)) +
ggsave(paste('zrep_all_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 16, height = 16)
}
```

```{r}
for (plot_head_id in c(8,10,11,15,19,21,26,44,45,48,50,51,53)) {
for (plot_cue_type in c("context","verb")) {
  d.zindiv %>%
    filter(cue_type==plot_cue_type) %>%
    filter(head_id==plot_head_id) %>%
    mutate(pos_type=factor(pos_type,levels=c('options','masks','rest'))) %>%
    group_by(pos_type, layer_id) %>%
    #summarize(effect_ave = mean(effect_ave)) %>%
    tidyboot_mean(effect_ave, nboot = 1000) %>%
    ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = pos_type, group = pos_type)) +
      geom_hline(yintercept=0) +
      geom_line(size=1.2,position = position_dodge(width = 0.3)) +
      geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.8,size=0.8,linetype='solid',position = position_dodge(width = 0.3)) +
      theme_few() +
      scale_color_manual(values=c("#56B4E9","#009E73","#000000")) +
      #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
      labs(x = 'Layer', y ='Effect') +
      guides(color=guide_legend(ncol=1)) +
      theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(),
            axis.text.x=element_text(size=10),axis.text.y=element_text(size=14), axis.title=element_text(size=18),
            strip.text=element_text(size=16), legend.text=element_text(size=16)) +
  ggsave(paste('headwise/zrep/zrep_head_',plot_head_id,'_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 3, height = 4)
}}
```

```{r}
for (plot_cue_type in c("context","verb")) {
  d.zindiv %>%
    filter(cue_type==plot_cue_type) %>%
    group_by(layer_id, head_id, pos_type) %>%
    summarize(p.val = t.test(effect_ave)$p.value,
              t.val = t.test(effect_ave)$statistic) %>%
    mutate(p.log=(-log10(p.val))) %>%
    mutate(t.bool=t.val>0) %>%
    group_by(head_id,pos_type) %>%
    slice_max(p.log) %>%
    #mutate(p.log=p.log*t.bool) %>%
    ggplot(aes(x = as.factor(head_id), y = p.log, color = t.bool)) +
      {if(plot_cue_type=="context")geom_hline(yintercept = 8, linetype="dotted")}+
      {if(plot_cue_type=="verb")geom_hline(yintercept = 24, linetype="dotted")} +
      geom_point(show.legend = FALSE) +
      theme_few() +
      labs(x = 'Head', y ='-log p',parse=TRUE) +
      #scale_color_manual(values=c("gray","black")) +
      facet_wrap( ~ pos_type, scales="free_x",ncol=1) +
      theme(aspect.ratio = 1/12,legend.position = 'top', legend.title = element_blank(),
            panel.border = element_blank(),axis.line = element_line(colour = "black"),
            axis.text.x=element_text(size=7),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
            strip.text=element_text(size=10), legend.text=element_text(size=16))+
  ggsave(paste('zrep_all_pval_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 8, height = 8)
}
```

```{r}
d.zindiv %>%
  filter(pos_type %in% c("context","verb","options","masks","rest")) %>%
  group_by(cue_type, layer_id, head_id, pos_type) %>%
  mutate(p.val = t.test(effect_ave)$p.value,
         t.val = t.test(effect_ave)$statistic) %>%
  mutate(p.log=(-log10(p.val))) %>%
  #mutate(t.bool=t.val>0) %>%
  group_by(cue_type, head_id, pos_type) %>%
  slice_max(t.val) %>%
  tidyboot_mean(effect_ave,nboot=10) %>%
  select(cue_type,head_id,pos_type,empirical_stat,ci_lower,ci_upper) %>%
  pivot_wider(names_from=cue_type,values_from=c("empirical_stat","ci_lower","ci_upper")) %>%
  mutate(effect_context=empirical_stat_context,effect_verb=empirical_stat_verb) %>%
  ggplot(aes(x = effect_verb, y = effect_context)) +
    geom_point(show.legend = FALSE) +
    theme_few() +
    facet_wrap(~ pos_type, scales="free") +
    geom_errorbarh(aes(xmin=ci_lower_verb, xmax=ci_upper_verb))+
    geom_errorbar(aes(ymin=ci_lower_context, ymax=ci_upper_context)) +
  ggsave('zrep_all_scatter_effect.pdf', units = 'in', width = 9, height = 6)
```

```{r}
d.zindiv %>%
  filter(pos_type %in% c("context","verb","options","masks","rest")) %>%
  group_by(cue_type, layer_id, head_id, pos_type) %>%
  summarize(p.val = t.test(effect_ave)$p.value,
            t.val = t.test(effect_ave)$statistic) %>%
  mutate(p.log=(-log10(p.val))) %>%
  #mutate(t.bool=t.val>0) %>%
  group_by(cue_type, head_id, pos_type) %>%
  slice_max(t.val) %>%
  select(cue_type,head_id,pos_type,p.log) %>%
  pivot_wider(names_from=cue_type,values_from=p.log) %>%
  mutate(logp_context=context,logp_verb=verb) %>%
  ggplot(aes(x = logp_verb, y = logp_context)) +
    geom_point(show.legend = FALSE) +
    theme_few() +
    facet_wrap(~ pos_type, scales="free") +
  ggsave('zrep_all_scatter_pval.pdf', units = 'in', width = 9, height = 6)
```

```{r}
calc_rank_diff <- function(data){
  data_new <- data %>%
    group_by(cue_type, layer_id, head_id, pos_type) %>%
    summarize(p.val = t.test(effect_ave)$p.value,
              t.val = t.test(effect_ave)$statistic) %>%
    group_by(cue_type, head_id, pos_type) %>%
    slice_max(t.val) %>%
    group_by(cue_type, pos_type) %>%
    mutate(rank = (min_rank(desc(t.val)))) %>%
    select(cue_type,head_id,pos_type,rank) %>%
    pivot_wider(names_from=cue_type,values_from=c("rank")) %>%
    mutate(rank_diff=context-verb)
}
```

```{r}
resample_data <- function(data){
  data_new <- bind_rows(data %>% 
                          filter(cue_type=="context") %>% 
                          group_by(layer_id, head_id, pos_type) %>%
                          slice_sample(n=63,replace=T),
                        data %>% 
                          filter(cue_type=="verb") %>% 
                          group_by(layer_id, head_id, pos_type) %>%
                          slice_sample(n=177,replace=T))
}
```

```{r}
change_col_name <- function(data,boot_id){
  var_name <- paste("rank_diff_",boot_id)
  data[[var_name]] <- data %>% select(rank_diff)
  data
}
```

```{r}
sample <- d.zindiv %>%
  filter(pos_type %in% c("context","verb","options","masks","rest")) %>%
  tidyboot(summary_function=mean,
           statistics_functions = calc_rank_diff,
           nboot=10)
```

```{r}
d.rank <- data.frame()
for (boot_id in 1:100) {
  d.rank <- bind_rows(d.rank,
                      d.zindiv %>%
                        filter(pos_type %in% c("context","verb","options","masks","rest")) %>%
                        resample_data %>%
                        calc_rank_diff %>%
                        mutate(boot_id=boot_id))
}
d.rank %>% write_csv("rank_diff_zindiv.csv")
```

```{r}
d.rank <- read_csv("rank_diff_zindiv.csv")
d.rank %>%
  group_by(pos_type,head_id) %>%
  summarize(rank_diff_mean=mean(rank_diff),rank_diff_sd=sd(rank_diff)) %>%
  mutate(color="0") %>%
  mutate(color = replace(color,rank_diff_mean-1.96*rank_diff_sd>0,"1")) %>%
  mutate(color = replace(color,rank_diff_mean+1.96*rank_diff_sd<0,"-1")) %>%
  ggplot(aes(x=as.factor(head_id),y=rank_diff_mean,color=color)) +
    geom_point() +
    geom_hline(yintercept = 0, linetype="dotted") +
    geom_errorbar(aes(ymin=rank_diff_mean-1.96*rank_diff_sd, ymax=rank_diff_mean+1.96*rank_diff_sd),
                  width=0.8,size=0.8,linetype='solid') +
    scale_color_manual(values=c("#E69F00","#000000","#56B4E9")) +
    theme_few() +
    facet_wrap(~ pos_type, scales="free", ncol = 1) +
  ggsave('zrep_all_rank_diff.pdf', units = 'in', width = 12, height = 6)
```

```{r}
d.zindiv %>%
  filter(pos_type %in% c("context","verb","options","masks","rest")) %>%
  group_by(cue_type, layer_id, head_id, pos_type) %>%
  summarize(p.val = t.test(effect_ave)$p.value,
            t.val = t.test(effect_ave)$statistic) %>%
  group_by(cue_type, head_id, pos_type) %>%
  slice_max(t.val) %>%
  group_by(cue_type, pos_type) %>%
  mutate(rank = (min_rank(desc(t.val)))) %>%
  select(cue_type,head_id,pos_type,rank) %>%
  pivot_wider(names_from=cue_type,values_from=c("rank")) %>%
  mutate(rank_diff=context-verb)
```

```{r}
d.zindiv %>%
    filter(cue_type=="context") %>%
    group_by(layer_id, head_id, pos_type) %>%
    summarize(p.val = t.test(effect_ave)$p.value,
              t.val = t.test(effect_ave)$statistic) %>%
    mutate(p.log=(-log10(p.val))) %>%
    group_by(head_id,pos_type) %>%
    slice_max(p.log) %>%
    mutate(cut_off=-log10(0.001/12/64)) %>%
    filter(p.log>cut_off) %>%
    filter(t.val > 0) %>%
    #pull(head_id) %>% unique()
    pull(pos_type) %>% unique()
    #filter(pos_type=="cls-sep")
```

# 1.4.2 Attention/Q&K

```{r}
d.attqnk %>% pull(cue_type) %>% unique()
d.attqnk %>% pull(pos_type) %>% unique()
```

```{r}
for (plot_cue_type in c("context","verb")) {
d.attqnk %>%
  filter(cue_type==plot_cue_type) %>%
  group_by(head_id, layer_id, pos_type) %>%
  tidyboot_mean(effect_ave, nboot = 10) %>%
  ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = pos_type, group = pos_type, linetype = pos_type)) +
    geom_hline(yintercept=0) +
    geom_line(size=0.8,position = position_dodge(width = 0.3)) +
    geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.5,size=0.5,linetype='solid',position = position_dodge(width = 0.3)) +
    scale_color_manual(values=c("#000000","#E69F00","#56B4E9","#009E73","#F0E442","#0072B2","#D55E00","#CC79A7","#000000")) +
    scale_linetype_manual(values=c("dotted","solid","solid","solid","solid","solid","solid","solid","solid")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    facet_wrap( ~ head_id) +
    theme_few() +
    labs(x = 'Layer', y ='Effect') +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=7),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
          strip.text=element_text(size=10), legend.text=element_text(size=16)) +
ggsave(paste('attqnk_all_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 16, height = 16)
}
```

```{r}
for (plot_head_id in c(8,10,11,15,19,21,26,44,45,48,50,51,53)) {
for (plot_cue_type in c("context","verb")) {
d.attqnk %>%
  filter(cue_type==plot_cue_type) %>%
  filter(head_id==plot_head_id) %>%
  group_by(layer_id, pos_type) %>%
  tidyboot_mean(effect_ave, nboot = 1000) %>%
  ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = pos_type, group = pos_type)) +
    geom_hline(yintercept=0) +
    geom_line(size=1.2,position = position_dodge(width = 0.3)) +
    geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.8,size=0.8,linetype='solid',position = position_dodge(width = 0.3)) +
    scale_color_manual(values=c("#000000","#CC79A7","#0072B2")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    theme_few() +
    labs(x = 'Layer', y ='Effect') +
    guides(color=guide_legend(ncol=1)) +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=7),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
          strip.text=element_text(size=10), legend.text=element_text(size=16)) +
ggsave(paste('headwise/attqnk/attqnk_head_',plot_head_id,'_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 3, height = 4)
}}
```

```{r}
for (plot_cue_type in c("context","verb")) {
  d.attqnk%>%
    filter(cue_type==plot_cue_type) %>%
    group_by(layer_id, head_id, pos_type) %>%
    summarize(p.val = t.test(effect_ave)$p.value,
              t.val = t.test(effect_ave)$statistic) %>%
    mutate(p.log=(-log10(p.val))) %>%
    mutate(t.bool=t.val>0) %>%
    group_by(head_id,pos_type) %>%
    slice_max(p.log) %>%
    #mutate(p.log=p.log*t.bool) %>%
    ggplot(aes(x = as.factor(head_id), y = p.log, color = t.bool)) +
      {if(plot_cue_type=="context")geom_hline(yintercept = 8, linetype="dotted")}+
      {if(plot_cue_type=="verb")geom_hline(yintercept = 24, linetype="dotted")} +
      geom_point(show.legend = FALSE) +
      theme_few() +
      labs(x = 'Head', y ='-log p',parse=TRUE) +
      #scale_color_manual(values=c("gray","black")) +
      facet_wrap( ~ pos_type, scales="free_x",ncol=1) +
      theme(aspect.ratio = 1/20,legend.position = 'top', legend.title = element_blank(),
            panel.border = element_blank(),axis.line = element_line(colour = "black"),
            axis.text.x=element_text(size=7),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
            strip.text=element_text(size=10), legend.text=element_text(size=16))+
  ggsave(paste('qnk_all_pval_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 12, height = 12)
}
```

```{r}
d.attqnk %>%
  group_by(cue_type, layer_id, head_id, pos_type) %>%
  mutate(p.val = t.test(effect_ave)$p.value,
         t.val = t.test(effect_ave)$statistic) %>%
  mutate(p.log=(-log10(p.val))) %>%
  #mutate(t.bool=t.val>0) %>%
  group_by(cue_type, head_id, pos_type) %>%
  slice_max(t.val) %>%
  tidyboot_mean(effect_ave,nboot=10) %>%
  select(cue_type,head_id,pos_type,empirical_stat,ci_lower,ci_upper) %>%
  pivot_wider(names_from=cue_type,values_from=c("empirical_stat","ci_lower","ci_upper")) %>%
  mutate(effect_context=empirical_stat_context,effect_verb=empirical_stat_verb) %>%
  ggplot(aes(x = effect_verb, y = effect_context)) +
    geom_point(show.legend = FALSE) +
    theme_few() +
    facet_wrap(~ pos_type, scales="free") +
    geom_errorbarh(aes(xmin=ci_lower_verb, xmax=ci_upper_verb))+
    geom_errorbar(aes(ymin=ci_lower_context, ymax=ci_upper_context)) +
  ggsave('attqnk_all_scatter_effect.pdf', units = 'in', width = 9, height = 9)
```

```{r}
d.attqnk %>%
  group_by(cue_type, layer_id, head_id, pos_type) %>%
  summarize(p.val = t.test(effect_ave)$p.value,
            t.val = t.test(effect_ave)$statistic) %>%
  mutate(p.log=(-log10(p.val))) %>%
  #mutate(t.bool=t.val>0) %>%
  group_by(cue_type, head_id, pos_type) %>%
  slice_max(t.val) %>%
  select(cue_type,head_id,pos_type,p.log) %>%
  pivot_wider(names_from=cue_type,values_from=p.log) %>%
  mutate(logp_context=context,logp_verb=verb) %>%
  ggplot(aes(x = logp_verb, y = logp_context)) +
    geom_point(show.legend = FALSE) +
    theme_few() +
    facet_wrap(~ pos_type, scales="free") +
  ggsave('attqnk_all_scatter_pval.pdf', units = 'in', width = 9, height = 9)
```

# 1.4.3 Value

```{r}
d.val %>% pull(cue_type) %>% unique()
d.val %>% pull(pos_type) %>% unique()
```

```{r}
for (plot_cue_type in c("context","verb")) {
d.val %>%
  filter(cue_type==plot_cue_type) %>%
  group_by(head_id, layer_id, pos_type) %>%
  tidyboot_mean(effect_ave, nboot = 10) %>%
  ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = pos_type, group = pos_type)) +
    geom_hline(yintercept=0) +
    geom_line(size=0.8,position = position_dodge(width = 0.3)) +
    geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.5,size=0.5,linetype='solid',position = position_dodge(width = 0.3)) +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000","#0072B2","#CC79A7")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    facet_wrap( ~ head_id) +
    theme_few() +
    labs(x = 'Layer', y ='Effect') +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=7),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
          strip.text=element_text(size=10), legend.text=element_text(size=16)) +
ggsave(paste('value_all_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 16, height = 16)
}
```

```{r}
for (plot_head_id in c(8,10,11,15,19,21,26,44,45,48,50,51,53)) {
for (plot_cue_type in c("context","verb")) {
d.val %>%
  filter(cue_type==plot_cue_type) %>%
  filter(head_id==plot_head_id) %>%
  group_by(pos_type, layer_id) %>%
  #summarize(effect_ave = mean(effect_ave)) %>%
  tidyboot_mean(effect_ave, nboot = 1000) %>%
  ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = pos_type, group = pos_type)) +
    geom_hline(yintercept=0) +
    geom_line(size=1.2,position = position_dodge(width = 0.3)) +
    geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.8,size=0.8,linetype='solid',position = position_dodge(width = 0.3)) +
    theme_few() +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000","#0072B2","#CC79A7")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    labs(x = 'Layer', y ='Effect') +
    guides(color=guide_legend(ncol=2)) +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(),
          axis.text.x=element_text(size=10),axis.text.y=element_text(size=14), axis.title=element_text(size=18),
          strip.text=element_text(size=16), legend.text=element_text(size=16)) +
ggsave(paste('headwise/val/val_head_',plot_head_id,'_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 3, height = 4)
}}
```

```{r}
for (plot_cue_type in c("context","verb")) {
  d.val %>%
    filter(cue_type==plot_cue_type) %>%
    group_by(layer_id, head_id, pos_type) %>%
    summarize(p.val = t.test(effect_ave)$p.value,
              t.val = t.test(effect_ave)$statistic) %>%
    mutate(p.log=(-log10(p.val))) %>%
    mutate(t.bool=t.val>0) %>%
    group_by(head_id,pos_type) %>%
    slice_max(p.log) %>%
    #mutate(p.log=p.log*t.bool) %>%
    ggplot(aes(x = as.factor(head_id), y = p.log, color = t.bool)) +
      {if(plot_cue_type=="context")geom_hline(yintercept = 8, linetype="dotted")}+
      {if(plot_cue_type=="verb")geom_hline(yintercept = 24, linetype="dotted")} +
      geom_point(show.legend = FALSE) +
      theme_few() +
      labs(x = 'Head', y ='-log p',parse=TRUE) +
      #scale_color_manual(values=c("gray","black")) +
      facet_wrap( ~ pos_type, scales="free_x",ncol=1) +
      theme(aspect.ratio = 1/12,legend.position = 'top', legend.title = element_blank(),
            panel.border = element_blank(),axis.line = element_line(colour = "black"),
            axis.text.x=element_text(size=7),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
            strip.text=element_text(size=10), legend.text=element_text(size=16))+
  ggsave(paste('val_all_pval_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 8, height = 8)
}
```

```{r}
d.val %>%
  filter(pos_type %in% c("context","verb","options","masks","rest")) %>%
  group_by(cue_type, layer_id, head_id, pos_type) %>%
  mutate(p.val = t.test(effect_ave)$p.value,
         t.val = t.test(effect_ave)$statistic) %>%
  mutate(p.log=(-log10(p.val))) %>%
  #mutate(t.bool=t.val>0) %>%
  group_by(cue_type, head_id, pos_type) %>%
  slice_max(t.val) %>%
  tidyboot_mean(effect_ave,nboot=10) %>%
  select(cue_type,head_id,pos_type,empirical_stat,ci_lower,ci_upper) %>%
  pivot_wider(names_from=cue_type,values_from=c("empirical_stat","ci_lower","ci_upper")) %>%
  mutate(effect_context=empirical_stat_context,effect_verb=empirical_stat_verb) %>%
  ggplot(aes(x = effect_verb, y = effect_context)) +
    geom_point(show.legend = FALSE) +
    theme_few() +
    facet_wrap(~ pos_type, scales="free") +
    geom_errorbarh(aes(xmin=ci_lower_verb, xmax=ci_upper_verb))+
    geom_errorbar(aes(ymin=ci_lower_context, ymax=ci_upper_context)) +
  ggsave('value_all_scatter_effect.pdf', units = 'in', width = 9, height = 6)
```

```{r}
d.val %>%
  filter(pos_type %in% c("context","verb","options","masks","rest")) %>%
  group_by(cue_type, layer_id, head_id, pos_type) %>%
  summarize(p.val = t.test(effect_ave)$p.value,
            t.val = t.test(effect_ave)$statistic) %>%
  mutate(p.log=(-log10(p.val))) %>%
  #mutate(t.bool=t.val>0) %>%
  group_by(cue_type, head_id, pos_type) %>%
  slice_max(t.val) %>%
  select(cue_type,head_id,pos_type,p.log) %>%
  pivot_wider(names_from=cue_type,values_from=p.log) %>%
  mutate(logp_context=context,logp_verb=verb) %>%
  ggplot(aes(x = logp_verb, y = logp_context)) +
    geom_point(show.legend = FALSE) +
    theme_few() +
    facet_wrap(~ pos_type, scales="free") +
  ggsave('value_all_scatter_pval.pdf', units = 'in', width = 9, height = 6)
```