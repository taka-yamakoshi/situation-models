---
title: "R Notebook"
output: html_notebook
---

# Import dependencies

```{r}
library(tidyverse)
library(here)
library(ggthemes)
library(tidyboot)
```

# Import data

```{r}
d <- read_csv(here('results/combined_effect_ave_all/combined_effect_ave_layer-query-key-value_multihead.csv')) %>%
  filter(head_id==0) %>%
  separate(pair_id, into = c('prefix', 'pair_id'))
```

How many sentences?

```{r}
d %>% pull(cue_type) %>% unique()
d %>% pull(pair_id) %>% unique()
d %>% pull(pos_type) %>% unique()
```

# 1.1: Performance

```{r}
d %>%
  #filter(cue_type %in% c('context', 'verb')) %>%
  group_by(cue_type, pair_id) %>%
  summarize(acc = mean(original_score)) %>%
  group_by(cue_type) %>%
  summarize(n = sum(acc))
```

# 1.2: Layer-wise intervention
# Prep the data for plotting
```{r}
d <- d %>%
  #mutate(cue_type = replace(cue_type,cue_type=='synonym_1','synonym')) %>%
  #mutate(cue_type = replace(cue_type,cue_type=='synonym_2','synonym')) %>%
  mutate(cue_type = replace(cue_type,cue_type=='context_verb','context+verb')) %>%
  rename(position = pos_type) %>%
  rename(condition = cue_type) %>%
  mutate(layer_id = layer_id+1)
```

```{r}
colorblind_pal()(8)
```

```{r}
d %>%
  filter(original_score) %>%
  filter(condition %in% c('context','verb','context+verb')) %>%
  filter(position %in% c('context','verb','options', 'masks', 'rest')) %>%
  mutate(condition=factor(condition,levels=c('context','verb','context+verb'))) %>%
  mutate(position=factor(position,levels=c('context','verb','options','masks','rest'))) %>%
  group_by(condition, layer_id, position) %>%
  #summarize(effect_ave = mean(effect_ave)) %>%
  tidyboot_mean(effect_ave, nboot = 1000) %>%
  ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = position, group = position)) +
    geom_line(size=1.2,position = position_dodge(width = 0.4)) +
    geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.1,size=0.8,linetype='solid',position = position_dodge(width = 0.4)) +
    theme_few() +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    labs(x = 'Layer', y ='Effect') +
    geom_hline(yintercept=0) +
    facet_wrap(~ condition, scales="free_y") +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=10),axis.text.y=element_text(size=14), axis.title=element_text(size=18),
          strip.text=element_text(size=16), legend.text=element_text(size=16)) +
ggsave('layer.pdf', units = 'in', width = 9, height = 4)
```

```{r}
d %>%
  filter(condition=='context') %>%
  filter(!original_score & original_1<0 & original_2<0 & original_1>original_2) %>%
  pull(pair_id) %>% unique()
```

```{r}
d %>%
  filter(original_1<0 & original_2<0 & original_1<original_2) %>%
  filter(condition %in% c('context','verb','context+verb')) %>%
  filter(position %in% c('context','verb','options', 'masks', 'rest')) %>%
  mutate(condition=factor(condition,levels=c('context','verb','context+verb'))) %>%
  mutate(position=factor(position,levels=c('context','verb','options','masks','rest'))) %>%
  group_by(condition, layer_id, position) %>%
  #summarize(effect_ave = mean(effect_ave)) %>%
  tidyboot_mean(effect_ave, nboot = 1000) %>%
  ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = position, group = position)) +
    geom_line(size=1.2,position = position_dodge(width = 0.4)) +
    geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.1,size=0.8,linetype='solid',position = position_dodge(width = 0.4)) +
    theme_few() +
    scale_color_manual(values=c("#E69F00","#D55E00","#56B4E9","#009E73","#000000")) +
    labs(x = 'Layer', y ='Effect') +
    geom_hline(yintercept=0) +
    facet_wrap(~ condition, scales="free_y") +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=10),axis.text.y=element_text(size=14), axis.title=element_text(size=18),
          strip.text=element_text(size=16), legend.text=element_text(size=16)) +
ggsave('layer_split_1_2_0.pdf', units = 'in', width = 9, height = 4)
```


# Statistical analysis

Run (paired) t-tests at each layer to test where differences between sentence pairs emerge

```{r}
d %>%
  #filter(original_score) %>%
  filter(cue_type %in% c('context', 'verb')) %>%
  filter(pos_type == 'options') %>%
  group_by(pair_id, cue_type, layer_id, pos_type) %>%
  summarize(effect_ave = mean(effect_ave, rm.na = T)) %>%
  spread(cue_type, effect_ave) %>%
  group_by(layer_id) %>%
  summarize(p.val = t.test(context, verb, paired = T)$p.value,
            diff_size = mean(context - verb)) %>%
  mutate(significance_level = case_when(p.val < 0.001 ~ '***', p.val < 0.01 ~ '**', p.val < 0.05 ~ '*', TRUE ~ 'n.s.'))
```

Run single-sample t-tests at each layer to test where differences from 0 emerge

```{r}
d %>%
  filter(cue_type %in% c('context', 'verb')) %>%
  filter(pos_type == 'options') %>%
  group_by(pair_id, cue_type, layer_id, pos_type) %>%
  summarize(effect_ave = mean(effect_ave, rm.na = T)) %>%
  group_by(layer_id, cue_type) %>%
  summarize(p.val = t.test(effect_ave)$p.value) %>%
  mutate(significance_level = case_when(p.val < 0.001 ~ '***', p.val < 0.01 ~ '**', p.val < 0.05 ~ '*', TRUE ~ 'n.s.'))
```


# 1.3: Z-rep intervention (cumulative)

```{r}
d.zrep <- read_csv(here('results/combined_effect_ave_all/combined_effect_ave_z_rep_cascade_multihead.csv')) %>%
  filter(head_id==0) %>%
  separate(pair_id, into = c('prefix', 'pair_id'))
d.zrep <- d.zrep %>%
  mutate(cue_type = replace(cue_type,cue_type=='context_verb','context+verb')) %>%
  mutate(layer_id = layer_id+1) %>%
  rename(position = pos_type) %>%
  rename(condition = cue_type)
d.zrep %>% pull(condition) %>% unique()
d.zrep %>% pull(position) %>% unique()
```

```{r}
d.zrep %>%
  filter(original_score) %>%
  filter(position %in% c('options', 'masks','rest')) %>%
  mutate(condition=factor(condition,levels=c('context','verb','context+verb'))) %>%
  mutate(position=factor(position,levels=c('options','masks','rest'))) %>%
  group_by(condition, layer_id, position) %>%
  #summarize(effect_ave = mean(effect_ave)) %>%
  tidyboot_mean(effect_ave, nboot = 1000) %>%
  ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = position, group = position)) +
    geom_hline(yintercept=0) +
    geom_line(size=1.2,position = position_dodge(width = 0.3)) +
    geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.1,size=0.8,linetype='solid',position = position_dodge(width = 0.3)) +
    theme_few() +
    scale_color_manual(values=c("#56B4E9","#009E73","#000000")) +
    labs(x = 'Layer', y ='Effect') +
    facet_wrap( ~ condition, scales="free_y") +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=10),axis.text.y=element_text(size=14), axis.title=element_text(size=18),
          strip.text=element_text(size=16), legend.text=element_text(size=16)) +
ggsave('zrep.pdf', units = 'in', width = 6, height = 4)
```


# 1.4: fine-grained analyses

```{r}
d.zindiv <- read_csv(here('results/combined_effect_ave_all/combined_effect_ave_z_rep.csv'))
d.att <- read_csv(here('results/combined_effect_ave_all/combined_effect_ave_attention.csv'))
d.qnk <- read_csv(here('results/combined_effect_ave_all/combined_effect_ave_q_and_k.csv'))
d.val <- read_csv(here('results/combined_effect_ave_all/combined_effect_ave_value.csv'))
d.head_7 <- bind_rows(d.val %>%
                        filter(head_id == 7) %>%
                        filter(pos_type %in% c("context","verb","rest")),
                      d.zindiv %>%
                        filter(head_id == 7) %>%
                        filter(pos_type=='masks'))
d.head_10 <- bind_rows(d.val %>%
                        filter(head_id == 10) %>%
                        filter(pos_type %in% c("context","verb","rest")),
                      d.zindiv %>%
                        filter(head_id == 10) %>%
                        filter(pos_type=='masks'))
d.head_18 <- bind_rows(d.val %>%
                        filter(head_id == 18) %>%
                        filter(pos_type == "verb"),
                      d.zindiv %>%
                        filter(head_id == 18) %>%
                        filter(pos_type=='masks'))
d.head_44 <- bind_rows(d.qnk %>%
                        filter(head_id == 44) %>%
                        filter(pos_type == "masks-options"),
                       #d.val %>%
                        #filter(head_id == 44) %>%
                        #filter(pos_type == "context"),
                       d.zindiv %>%
                        filter(head_id == 44) %>%
                        filter(pos_type=='options'))
d.head_47 <- bind_rows(d.qnk %>%
                        filter(head_id == 47) %>%
                        filter(pos_type == "options-masks"),
                       d.zindiv %>%
                        filter(head_id == 47) %>%
                        filter(pos_type=='masks'))
d.val %>% pull(cue_type) %>% unique()
d.val %>% pull(pos_type) %>% unique()
```

```{r}
plot_cue_type <- "context"

d.head_7 %>%
  filter(cue_type==plot_cue_type) %>%
  mutate(layer_id=layer_id+1) %>%
  mutate(head_id = head_id+1) %>%
  mutate(rep_type = replace(rep_type,rep_type=="z_rep","z@masks")) %>%
  mutate(rep_type = replace(rep_type,rep_type=="value","value@context")) %>%
  filter(original_score) %>%
  filter(pos_type %in% c('context','masks')) %>%
  mutate(rep_type=factor(rep_type,levels=c('z@masks','value@context'))) %>%
  group_by(rep_type, layer_id) %>%
  #summarize(effect_ave = mean(effect_ave)) %>%
  tidyboot_mean(effect_ave, nboot = 1000) %>%
  ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = rep_type, group = rep_type, linetype = rep_type)) +
    geom_hline(yintercept=0) +
    geom_line(size=1.2,position = position_dodge(width = 0.3)) +
    geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.1,size=0.8,linetype='solid',position = position_dodge(width = 0.3)) +
    theme_few() +
    #scale_color_colorblind() +
    scale_color_manual(values=c("#009E73","#E69F00")) +
    scale_linetype_manual(values=c("dotted","solid")) +
    labs(x = 'Layer', y ='Effect') +
    #geom_hline(yintercept=0) +
    guides(color=guide_legend(ncol =1)) +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(),
          axis.text.x=element_text(size=10),axis.text.y=element_text(size=14), axis.title=element_text(size=18),
          strip.text=element_text(size=16), legend.text=element_text(size=16)) +
ggsave(paste('head_8_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 3, height = 4)
```

```{r}
plot_cue_type <- "context"

d.head_10 %>%
  filter(cue_type==plot_cue_type) %>%
  mutate(layer_id=layer_id+1) %>%
  mutate(head_id = head_id+1) %>%
  mutate(rep_type = replace(rep_type,rep_type=="z_rep","z@masks")) %>%
  mutate(rep_type = replace(rep_type,rep_type=="value","value@context")) %>%
  filter(original_score) %>%
  filter(pos_type %in% c('context','masks')) %>%
  mutate(rep_type=factor(rep_type,levels=c('z@masks','value@context'))) %>%
  group_by(rep_type, layer_id) %>%
  #summarize(effect_ave = mean(effect_ave)) %>%
  tidyboot_mean(effect_ave, nboot = 1000) %>%
  ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = rep_type, group = rep_type, linetype = rep_type)) +
    geom_hline(yintercept=0) +
    geom_line(size=1.2,position = position_dodge(width = 0.3)) +
    geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.1,size=0.8,linetype='solid',position = position_dodge(width = 0.3)) +
    theme_few() +
    #scale_color_colorblind() +
    scale_color_manual(values=c("#009E73","#E69F00")) +
    scale_linetype_manual(values=c("dotted","solid")) +
    labs(x = 'Layer', y ='Effect') +
    #geom_hline(yintercept=0) +
    guides(color=guide_legend(ncol =1)) +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(),
          axis.text.x=element_text(size=10),axis.text.y=element_text(size=14), axis.title=element_text(size=18),
          strip.text=element_text(size=16), legend.text=element_text(size=16)) +
ggsave(paste('head_11_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 3, height = 4)
```

```{r}
plot_cue_type <- "context"

d.head_18 %>%
  filter(cue_type==plot_cue_type) %>%
  mutate(layer_id=layer_id+1) %>%
  mutate(head_id = head_id+1) %>%
  mutate(rep_type = replace(rep_type,rep_type=="z_rep","z@masks")) %>%
  mutate(rep_type = replace(rep_type,rep_type=="value","value@verb")) %>%
  filter(original_score) %>%
  filter(pos_type %in% c('verb','masks')) %>%
  mutate(rep_type=factor(rep_type,levels=c('z@masks','value@verb'))) %>%
  group_by(rep_type, layer_id) %>%
  #summarize(effect_ave = mean(effect_ave)) %>%
  tidyboot_mean(effect_ave, nboot = 1000) %>%
  ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = rep_type, group = rep_type, linetype = rep_type)) +
    geom_hline(yintercept=0) +
    geom_line(size=1.2,position = position_dodge(width = 0.3)) +
    geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.1,size=0.8,linetype='solid',position = position_dodge(width = 0.3)) +
    theme_few() +
    #scale_color_colorblind() +
    scale_color_manual(values=c("#009E73","#D55E00")) +
    scale_linetype_manual(values=c("dotted","solid")) +
    labs(x = 'Layer', y ='Effect') +
    #geom_hline(yintercept=0) +
    guides(color=guide_legend(ncol =1)) +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(),
          axis.text.x=element_text(size=10),axis.text.y=element_text(size=14), axis.title=element_text(size=18),
          strip.text=element_text(size=16), legend.text=element_text(size=16)) +
ggsave(paste('head_19_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 3, height = 4)
```

```{r}
plot_cue_type <- "context"

d.head_44 %>%
  filter(cue_type==plot_cue_type) %>%
  mutate(layer_id=layer_id+1) %>%
  mutate(head_id = head_id+1) %>%
  mutate(rep_type = replace(rep_type,rep_type=="z_rep","z@options")) %>%
  mutate(rep_type = replace(rep_type,rep_type=="q_and_k","query@options\n& key@masks")) %>%
  filter(original_score) %>%
  filter(pos_type %in% c('masks-options','options')) %>%
  mutate(rep_type=factor(rep_type,levels=c('z@options','query@options\n& key@masks'))) %>%
  group_by(rep_type, layer_id) %>%
  #summarize(effect_ave = mean(effect_ave)) %>%
  tidyboot_mean(effect_ave, nboot = 1000) %>%
  ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = rep_type, group = rep_type, linetype = rep_type)) +
    geom_hline(yintercept=0) +
    geom_line(size=1.2,position = position_dodge(width = 0.3)) +
    geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.1,size=0.8,linetype='solid',position = position_dodge(width = 0.3)) +
    theme_few() +
    #scale_color_colorblind() +
    scale_color_manual(values=c("#56B4E9","#CC79A7")) +
    #"#0072B2" "#D55E00" "#CC79A7"
    scale_linetype_manual(values=c("dotted","dashed")) +
    labs(x = 'Layer', y ='Effect') +
    #geom_hline(yintercept=0) +
    guides(color=guide_legend(ncol =1)) +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=10),axis.text.y=element_text(size=14), axis.title=element_text(size=18),
          strip.text=element_text(size=16), legend.text=element_text(size=16)) +
ggsave(paste('head_45_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 3, height = 4)
```

```{r}
plot_cue_type <- "context"

d.head_47 %>%
  filter(cue_type==plot_cue_type) %>%
  mutate(layer_id=layer_id+1) %>%
  mutate(head_id = head_id+1) %>%
  mutate(rep_type = replace(rep_type,rep_type=="z_rep","z@masks")) %>%
  mutate(rep_type = replace(rep_type,rep_type=="q_and_k","query@masks\n& key@options")) %>%
  filter(original_score) %>%
  filter(pos_type %in% c('options-masks','masks')) %>%
  mutate(rep_type=factor(rep_type,levels=c('z@masks','query@masks\n& key@options'))) %>%
  group_by(rep_type, layer_id) %>%
  #summarize(effect_ave = mean(effect_ave)) %>%
  tidyboot_mean(effect_ave, nboot = 1000) %>%
  ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = rep_type, group = rep_type, linetype = rep_type)) +
    geom_hline(yintercept=0) +
    geom_line(size=1.2,position = position_dodge(width = 0.3)) +
    geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.1,size=0.8,linetype='solid',position = position_dodge(width = 0.3)) +
    theme_few() +
    #scale_color_colorblind() +
    scale_color_manual(values=c("#009E73","#0072B2")) +
    scale_linetype_manual(values=c("dotted","dashed")) +
    labs(x = 'Layer', y ='Effect') +
    #geom_hline(yintercept=0) +
    guides(color=guide_legend(ncol =1)) +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=10),axis.text.y=element_text(size=14), axis.title=element_text(size=18),
          strip.text=element_text(size=16), legend.text=element_text(size=16)) +
ggsave(paste('head_48_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 3, height = 4)
```


## Comprehensive Results for Supplementary
```{r}
d.head_all <- bind_rows(d.val%>%filter(pos_type%in%c('context','verb','rest')),d.qnk) %>%
  mutate(layer_id=layer_id+1) %>%
  mutate(head_id=head_id+1) %>%
  mutate(rep_type = replace(rep_type,rep_type=="q_and_k","query&key"))
  #mutate(head_id=str_c('Head ',head_id))
```

```{r}
plot_cue_type <- "verb"

d.head_all %>%
  filter(original_score) %>%
  filter(cue_type==plot_cue_type) %>%
  mutate(pos_type=factor(pos_type,levels=c('context','verb','rest','masks-options','options-masks'))) %>%
  group_by(head_id, layer_id, pos_type) %>%
  tidyboot_mean(effect_ave, nboot = 10) %>%
  ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = pos_type, group = pos_type)) +
    geom_hline(yintercept=0) +
    geom_line(size=1.0,position = position_dodge(width = 0.3)) +
    geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.1,size=0.8,linetype='solid',position = position_dodge(width = 0.3)) +
    scale_color_manual(values=c("#E69F00","#D55E00","#000000","#CC79A7","#0072B2")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    facet_wrap( ~ head_id) +
    theme_few() +
    labs(x = 'Layer', y ='Effect') +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=7),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
          strip.text=element_text(size=10), legend.text=element_text(size=16)) +
ggsave(paste('head_all_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 16, height = 16)
```

```{r}
d.zindiv %>% pull(cue_type) %>% unique()
d.zindiv %>% pull(pos_type) %>% unique()
d.zrep_all <- d.zindiv %>% 
  filter(pos_type%in%c('options','masks','rest')) %>%
  mutate(layer_id=layer_id+1) %>%
  mutate(head_id=head_id+1)
  #mutate(head_id=str_c('Head ',head_id))
```

```{r}
plot_cue_type = "verb"

d.zrep_all %>%
  filter(original_score) %>%
  filter(cue_type==plot_cue_type) %>%
  filter(pos_type%in%c('options','masks','rest')) %>%
  mutate(pos_type=factor(pos_type,levels=c('options','masks','rest'))) %>%
  group_by(head_id, layer_id, pos_type) %>%
  tidyboot_mean(effect_ave, nboot = 10) %>%
  ggplot(aes(x = as.factor(layer_id), y = empirical_stat, color = pos_type, group = pos_type)) +
    geom_hline(yintercept=0) +
    geom_line(size=1.0,position = position_dodge(width = 0.3)) +
    geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.1,size=0.8,linetype='solid',position = position_dodge(width = 0.3)) +
    scale_color_manual(values=c("#56B4E9","#009E73","#000000")) +
    #"#000000" "#E69F00" "#56B4E9" "#009E73" "#F0E442" "#0072B2" "#D55E00" "#CC79A7"
    facet_wrap( ~ head_id) +
    theme_few() +
    labs(x = 'Layer', y ='Effect') +
    theme(aspect.ratio = 1,legend.position = 'top', legend.title = element_blank(), 
          axis.text.x=element_text(size=7),axis.text.y=element_text(size=10), axis.title=element_text(size=16),
          strip.text=element_text(size=10), legend.text=element_text(size=16)) +
ggsave(paste('zrep_all_',plot_cue_type,'.pdf',sep=""), units = 'in', width = 16, height = 16)
```


